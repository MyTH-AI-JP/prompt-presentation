# Google Slide 変換フロー

## シーケンス図

```
┌────────────┐          ┌─────────────┐          ┌───────────────┐          ┌────────────────┐
│ ユーザー   │          │ フロントエンド │          │ バックエンドAPI │          │ Google Slides API │
└─────┬──────┘          └───────┬─────┘          └───────┬───────┘          └────────┬───────┘
      │                         │                         │                          │
      │  スライド生成リクエスト   │                         │                          │
      │────────────────────────>│                         │                          │
      │                         │                         │                          │
      │                         │  認証チェック           │                          │
      │                         │────────────────────────>│                          │
      │                         │                         │                          │
      │  認証が必要な場合         │                         │                          │
      │<────────────────────────│                         │                          │
      │                         │                         │                          │
      │  Googleにログイン        │                         │                          │
      │─────────────────────────┼─────────────────────────┼────────────────────────>│
      │                         │                         │                          │
      │  認証コード              │                         │                          │
      │<────────────────────────┼─────────────────────────┼─────────────────────────│
      │                         │                         │                          │
      │  認証コード送信          │                         │                          │
      │────────────────────────>│                         │                          │
      │                         │  認証コード→トークン交換   │                          │
      │                         │────────────────────────>│────────────────────────>│
      │                         │                         │                          │
      │                         │                         │  アクセストークン        │
      │                         │                         │<─────────────────────────│
      │                         │                         │                          │
      │                         │  Googleスライド作成リクエスト                         │
      │                         │────────────────────────>│                          │
      │                         │                         │                          │
      │                         │                         │  プレゼンテーション作成     │
      │                         │                         │────────────────────────>│
      │                         │                         │                          │
      │                         │                         │  プレゼンテーションID     │
      │                         │                         │<─────────────────────────│
      │                         │                         │                          │
      │                         │                         │  各スライド追加 (バッチ)   │
      │                         │                         │────────────────────────>│
      │                         │                         │                          │
      │                         │                         │  スライド追加結果         │
      │                         │                         │<─────────────────────────│
      │                         │                         │                          │
      │                         │                         │  スライドコンテンツ追加    │
      │                         │                         │────────────────────────>│
      │                         │                         │                          │
      │                         │                         │  コンテンツ追加結果       │
      │                         │                         │<─────────────────────────│
      │                         │                         │                          │
      │                         │                         │  スタイル適用             │
      │                         │                         │────────────────────────>│
      │                         │                         │                          │
      │                         │                         │  スタイル適用結果         │
      │                         │                         │<─────────────────────────│
      │                         │                         │                          │
      │                         │                         │  プレゼンテーションURL取得 │
      │                         │                         │────────────────────────>│
      │                         │                         │                          │
      │                         │                         │  プレゼンテーションURL    │
      │                         │                         │<─────────────────────────│
      │                         │                         │                          │
      │                         │  プレゼンテーションURL    │                          │
      │                         │<────────────────────────│                          │
      │                         │                         │                          │
      │  プレゼンテーションURL    │                         │                          │
      │<────────────────────────│                         │                          │
      │                         │                         │                          │
      │  Googleスライドを開く     │                         │                          │
      │────────────────────────────────────────────────────────────────────────────>│
      │                         │                         │                          │
└─────┴──────┘          └───────┴─────┘          └───────┴───────┘          └────────┴───────┘
```

## 処理フロー

1. **リクエスト開始**
   - ユーザーが「Googleスライドで作成」ボタンをクリック
   - フロントエンドはユーザーの認証状態を確認

2. **Google認証**
   - 認証が必要な場合、Google OAuth認証フローを開始
   - ユーザーがGoogleアカウントでログイン
   - 認証コードを取得し、アクセストークンに交換

3. **プレゼンテーション作成**
   - バックエンドAPIがGoogle Slides APIを呼び出し
   - 新しい空のプレゼンテーションを作成
   - プレゼンテーションIDを取得

4. **スライド追加**
   - 各スライドのレイアウトを決定（タイトル、コンテンツ、要約など）
   - バッチAPIコールで複数のスライドを一度に作成
   - スライドの基本構造の作成が完了

5. **コンテンツ追加**
   - HTMLコンテンツをプレーンテキストに変換
   - タイトル、本文、フッターなどのコンテンツを追加
   - テキストスタイルの設定（フォント、サイズ、色など）

6. **スタイル適用**
   - スライド全体のテーマを適用
   - 背景色/グラデーションの設定
   - 共通のスタイル要素を適用（フォント、色など）

7. **完了処理**
   - プレゼンテーションのURLを取得
   - ユーザーにURLを返す
   - 進捗表示の更新と完了メッセージの表示

## データフロー

### 1. 入力データ

```javascript
// HTML形式のスライドデータ
const presentationData = {
  title: "プレゼンテーションタイトル",
  theme: "modern",
  slides: [
    {
      type: "title",
      title: "メインタイトル",
      content: "サブタイトル内容"
    },
    {
      type: "content",
      title: "コンテンツスライド",
      content: "<p>HTML形式のコンテンツ</p><ul><li>項目1</li><li>項目2</li></ul>",
      footer: "フッター情報"
    },
    // 他のスライド...
  ]
};
```

### 2. Google Slideへの変換

```javascript
// Google Slides APIリクエスト例（スライド作成）
const createSlideRequests = slidesData.map((slide, index) => ({
  createSlide: {
    objectId: `slide_${index}`,
    insertionIndex: index,
    slideLayoutReference: {
      predefinedLayout: getLayoutType(slide.type)
    }
  }
}));

// コンテンツ追加リクエスト例
const contentRequests = slidesData.flatMap((slide, index) => {
  const requests = [];
  
  // タイトルの追加
  if (slide.title) {
    requests.push({
      insertText: {
        objectId: `title_${index}`,
        text: slide.title
      }
    });
  }
  
  // 本文の追加（HTMLをプレーンテキストに変換）
  if (slide.content) {
    requests.push({
      insertText: {
        objectId: `body_${index}`,
        text: htmlToPlainText(slide.content)
      }
    });
  }
  
  return requests;
});
```

### 3. 出力結果

```javascript
// APIレスポンス例
const response = {
  success: true,
  presentationId: "1Abc123XyZ_ExamplePresentationId",
  url: "https://docs.google.com/presentation/d/1Abc123XyZ_ExamplePresentationId/edit"
};
```

## エラーハンドリングフロー

1. **認証エラー**
   - トークン期限切れ → リフレッシュトークンで再取得
   - 認証情報無効 → 再認証フローを開始
   - 権限不足 → 適切なスコープで再認証を要求

2. **API制限エラー**
   - 429エラー → エクスポネンシャルバックオフ実装
   - バッチサイズ削減 → リクエスト数を分散
   - ユーザーへの通知 → 一時的な問題として説明

3. **変換エラー**
   - 部分失敗 → 成功した部分まで処理を継続
   - フォーマットエラー → デフォルト値を使用
   - プレースホルダ未検出 → カスタムテキストボックスを作成

## パフォーマンス最適化

1. **バッチリクエスト**
   - 複数のAPIコールを一つのバッチリクエストにまとめる
   - 同種の操作をグループ化（スライド作成、テキスト追加など）

2. **キャッシュ**
   - 認証トークンをセッションに保存
   - スライドテンプレートを事前定義

3. **非同期処理**
   - 進捗表示によるユーザー体験向上
   - バックグラウンド処理の実装（大量スライドの場合） 